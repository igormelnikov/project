# Otus Project

Финальный проект Otus Devops, описание  MVP.

## Установка

- `cd infra/terraform`
- Установить переменную `project` - ID проекта в GCE, где будет развёрнута инфраструктура.
- `terraform apply`
- `cd ../ansible`
- Указать соответствующий URL докер-хоста в `docker-compose.yml`.
- `ansible-playbook gitlab-ci.yml`
- Установить переменную `reg_token` - Registration token для раннеров.
- `ansible-playbook runners.yml`

## Описание CI/CD системы

Gitlab хост разворачивается на GCE с помощью Terraform, Ansible и docker-compose. Используется заранее созданный домен imel-project.ml, указывающий на IP-адрес Gitlab хоста. Это необходимо для получения сертификата с помощью Let's Encrypt и организации Docker registry на самом хосте с доступом по HTTPS, порт 4567.

Terraform создаёт:
1. Сам инстанс;
2. Необходимые правила файрволла для хоста Gitlab и хостов окружений;
3. Бакет для хранения состояния окружений. 

## Конфигурация микросервисного приложения

Все репозитории объединены в группу **otus-project** https://imel-project.ml/otus-project

В группе определены секретные переменные окружения:

- `GOOGLE_CREDENTIALS` - json-файл сервис аккаунта GCE;
- `GOOGLE_APPUSER_KEY` - файл приватного ключа appuser;
- `GCLOUD_PROJECT_NAME` - название проекта GCE.

- **ui** https://imel-project.ml/otus-project/ui/ - репозиторий Search Engine UI с добавленным Dockerfile для создания контейнера на базе python-alpine, в котором указаны переменные окружения для связи с необходимыми сервисами.
 
- **crawler** https://imel-project.ml/otus-project/crawler/ - репозиторий Search Engine Crawler с добавленным Dockerfile для создания контейнера на базе python-alpine, в котором указаны переменные окружения для связи с необходимыми сервисами. 
  
- **deploy** https://imel-project.ml/otus-project/deploy/ - репозиторий кода для развёртывания микросервисного приложения: компоненты ui и crawler, а также необходимые сервисы mongodb и rabbitmq.
  
## CI/CI пайплайн

Для репозиториев **ui** и **crawler** описана конфигурация пайплайна в `.gitlab-ci.yml`.

1. **Build** - сборка образа и пуш в Gitlab Registry с тэгом соответствующей ветки.
2. **Review** - поднятие динамического окружения для веток, отличных от **master** и деплой микросервисного приложения. Плейбук Ansible параметризован, чтобы для текущего репозитория использовался релиз текущей ветки (напр. feature-1), а для остальных - master. Приложение доступно по адресу инстанса окружения и порту 8000.
3. **Cleanup** - удаление динамического окружения с ручной активацией. 

Окружение представляет собой инстанс в GCE с соответствующим названием.
Terraform и Ansible были использованы для деплоя, поскольку docker-machine создаёт хост с нуля, не проверяя его состояние, и хранит конфигурацию локально, а сервера окружений должны быть сохранены между пайплайнами. Terraform хранит конфигурацию в удалённом бакенде, а Ansible проверяет необходимость внесения изменений.

На данный момент ссылки на окружения являются плейсхолдерами.

## Запланированные фичи

1. Добавление тестов перед review.
2. Создание статических окружений staging и production, на которые происходит деплой из master.
3. Конфигурация доступов к окружениям по ссылке в Gitlab CI.
4. Разбиение кода .gitlab-ci.yml на скрипты.
5. Параметризация конфигураций сервисов в Ansible (напр. MONGO, MONGO_PORT)
6. Мониторинг.
